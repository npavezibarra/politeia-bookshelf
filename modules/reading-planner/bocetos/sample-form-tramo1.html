<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Plan de Lectura - Modelo CCL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-black: #000000;
            --color-deep-gray: #333333;
            --color-gold: #C79F32;
            --color-orange: #FF8C00;
            --color-light-gray: #A8A8A8;
            --color-subtle-gray: #F5F5F5;
            --color-off-white: #FEFEFF;
        }

        body {
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            background-color: var(--color-off-white);
            color: var(--color-deep-gray);
        }

        .rounded-custom { border-radius: 6px !important; }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: var(--color-subtle-gray); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--color-light-gray); border-radius: 6px; }

        .calendar-card { background-color: var(--color-subtle-gray); border: 1px solid var(--color-light-gray); }
        .day-cell { background-color: var(--color-off-white); border: 1px solid var(--color-light-gray); transition: all 0.2s ease; }
        .drag-over { background-color: #fffaf0; border: 2px dashed var(--color-orange) !important; }
        .selected-mark { background-color: var(--color-gold); cursor: grab; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        .btn-primary { background-color: var(--color-black); color: var(--color-gold); border: 1px solid var(--color-black); transition: all 0.3s ease; }
        .btn-primary:hover:not(:disabled) { background-color: #1a1a1a; transform: translateY(-1px); }
        
        .toggle-container { height: 24px; background-color: #E5E5E5; padding: 2px; border-radius: 6px; display: flex; align-items: center; }
        .toggle-btn { height: 20px; padding: 0 8px; border-radius: 4px; display: flex; align-items: center; cursor: pointer; transition: all 0.2s ease; }
        .toggle-btn.active { background-color: var(--color-black); color: var(--color-gold); }
        
        .view-transition { transition: opacity 0.4s ease, transform 0.4s ease; width: 100%; }
        .view-hidden { opacity: 0; transform: translateY(10px); pointer-events: none; position: absolute; top: 0; left: 0; }
        .view-visible { opacity: 1; transform: translateY(0); pointer-events: auto; position: relative; }
        
        .nav-btn-circ { width: 28px; height: 28px; border-radius: 50%; border: 1.5px solid var(--color-light-gray); display: flex; align-items: center; justify-content: center; color: var(--color-black); transition: all 0.2s ease; cursor: pointer; }
        .nav-btn-circ:hover:not(.disabled) { background-color: var(--color-black); border-color: var(--color-black); color: var(--color-gold); }
        .nav-btn-circ.disabled { opacity: 0.15; cursor: not-allowed; }

        .pagination-btn { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--color-light-gray); border-radius: 4px; transition: all 0.2s ease; cursor: pointer; background: white; }
        .pagination-btn:hover:not(.disabled) { border-color: var(--color-black); color: var(--color-gold); background: var(--color-black); }
        .pagination-btn.disabled { opacity: 0.3; cursor: not-allowed; }

        .step-transition { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="text-deep-gray">

    <div id="app" class="min-h-screen flex items-center justify-center p-4">
        
        <!-- FORMULARIO DE PASOS -->
        <div id="form-container" class="bg-[#FEFEFF] w-full max-w-xl rounded-custom shadow-2xl overflow-hidden border border-[#A8A8A8] flex flex-col hidden">
            <div class="bg-[#F5F5F5] h-1.5 flex" id="progress-bar">
                <div class="flex-1 transition-all duration-700"></div>
                <div class="flex-1 transition-all duration-700"></div>
                <div class="flex-1 transition-all duration-700"></div>
            </div>

            <div class="p-10 flex-1 flex flex-col">
                <div class="flex justify-between items-center mb-10">
                    <span id="step-badge" class="px-3 py-1 bg-[#F5F5F5] text-[#C79F32] rounded-custom text-[10px] font-medium uppercase tracking-[0.2em] border border-[#A8A8A8]">
                        Sección 1 de 3
                    </span>
                    <button id="back-btn" class="text-[#A8A8A8] hover:text-[#000000] flex items-center gap-1 text-[10px] font-medium uppercase tracking-widest transition-colors hidden">
                        <i data-lucide="chevron-left" class="w-3 h-3"></i> Atrás
                    </button>
                </div>

                <div id="step-content" class="flex-1 min-h-[400px]"></div>

                <div class="mt-12 flex justify-end">
                    <button id="next-btn" class="w-full md:w-auto bg-[#C79F32] text-[#000000] px-12 py-5 rounded-custom font-medium flex items-center justify-center gap-3 hover:opacity-90 transition-all disabled:opacity-30 disabled:grayscale shadow-2xl shadow-[#C79F32]/20 uppercase text-[10px] tracking-[0.2em]">
                        <span>Siguiente</span>
                        <i data-lucide="chevron-right" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- PANTALLA DE PROPUESTA ELÁSTICA -->
        <div id="summary-container" class="calendar-card rounded-custom shadow-2xl p-6 max-w-xl w-full hidden">
            <div class="mb-6 text-center">
                <h2 class="text-[10px] font-medium text-black tracking-[0.25em] uppercase mb-1 opacity-80">PROPUESTA DE LECTURA REALISTA</h2>
                <h3 id="propuesta-libro-titulo" class="text-sm font-medium text-black uppercase mb-3 tracking-wide">Título del Libro</h3>
                <div class="w-full h-[1px] bg-[#A8A8A8] opacity-30"></div>
            </div>

            <header class="flex justify-between items-start mb-4">
                <div>
                    <div class="flex items-center space-x-3">
                        <h1 id="propuesta-mes-label" class="text-2xl font-medium text-black tracking-tight uppercase leading-tight">---</h1>
                        <div id="calendar-nav-controls" class="flex space-x-1">
                            <button id="calendar-prev-month" class="nav-btn-circ" title="Mes Anterior">
                                <i data-lucide="chevron-left" class="w-4 h-4"></i>
                            </button>
                            <button id="calendar-next-month" class="nav-btn-circ" title="Mes Siguiente">
                                <i data-lucide="chevron-right" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-[10px] text-deep-gray font-medium uppercase tracking-widest mt-0.5">Planificación Mensual</p>
                    <div id="propuesta-meta-info" class="mt-4 space-y-1">
                        <div id="propuesta-carga" class="text-[11px] font-medium text-[#C79F32] uppercase tracking-wide">Carga: -- PÁGINAS / SESIÓN</div>
                        <div id="propuesta-duracion" class="text-[10px] font-medium text-black/60 uppercase tracking-wider">Estimado: -- SEMANAS</div>
                    </div>
                </div>
                <div class="flex flex-col items-end">
                    <!-- Cambio: VISTA pasa a ser SESIONES con subtítulo indicativo -->
                    <div class="flex flex-col items-end">
                        <div class="flex items-center space-x-2">
                            <span class="w-2.5 h-2.5 rounded-full bg-[#C79F32]"></span>
                            <span class="text-[10px] font-medium text-black uppercase tracking-wider">SESIONES</span>
                        </div>
                        <p class="text-[8px] text-deep-gray font-medium opacity-60 mt-0.5 tracking-tight">arrastra a otra fecha para ajustar</p>
                    </div>
                    
                    <div class="toggle-container mt-3">
                        <div id="toggle-calendar" class="toggle-btn active"><i data-lucide="calendar" class="w-3.5 h-3.5"></i></div>
                        <div id="toggle-list" class="toggle-btn"><i data-lucide="list" class="w-3.5 h-3.5"></i></div>
                    </div>
                    <!-- Paginación para la vista de lista -->
                    <div id="list-pagination" class="mt-3 flex items-center space-x-2 hidden">
                        <button id="list-prev-page" class="pagination-btn"><i data-lucide="chevron-left" class="w-3 h-3"></i></button>
                        <span id="list-page-info" class="text-[9px] font-black tracking-tighter uppercase opacity-60">1 / 1</span>
                        <button id="list-next-page" class="pagination-btn"><i data-lucide="chevron-right" class="w-3 h-3"></i></button>
                    </div>
                </div>
            </header>

            <div id="main-view-container" class="mt-4 relative overflow-hidden transition-[height] duration-500 ease-in-out">
                <div id="calendar-view-wrapper" class="view-transition view-visible">
                    <div class="grid grid-cols-7 mb-2 border-b border-black/5">
                        <div class="text-center text-[10px] font-medium text-black py-2">DOM</div>
                        <div class="text-center text-[10px] font-medium text-black py-2">LUN</div>
                        <div class="text-center text-[10px] font-medium text-black py-2">MAR</div>
                        <div class="text-center text-[10px] font-medium text-black py-2">MIÉ</div>
                        <div class="text-center text-[10px] font-medium text-black py-2">JUE</div>
                        <div class="text-center text-[10px] font-medium text-black py-2">VIE</div>
                        <div class="text-center text-[10px] font-medium text-black py-2">SÁB</div>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1.5 pt-2"></div>
                </div>
                <div id="list-view-wrapper" class="view-transition view-hidden">
                    <div id="list-view" class="space-y-2 py-2"></div>
                </div>
            </div>

            <div class="mt-8 flex flex-col items-center space-y-4">
                <button id="accept-button" class="btn-primary w-full py-4 rounded-custom font-medium uppercase tracking-widest text-sm shadow-lg">
                    Aceptar Propuesta
                </button>
                <button id="adjust-btn" class="text-[10px] font-medium uppercase text-[#A8A8A8] hover:text-black transition-colors tracking-widest">
                    Ajustar Datos del Plan
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- MOTOR CCL (Capacidad de Carga Lectura) ---
        const TODAY = new Date(2026, 0, 6); // Enero 6, 2026
        const K_GROWTH = 1.15; 
        const MIN_PPS = 15; 
        const SESSIONS_PER_PAGE = 10;
        
        const PAGE_RANGES_MAP = { "<100": 80, "200~": 200, "400~": 400, "600~": 600, "1000~": 1000 };
        const EXIGENCIA_SESSIONS = { 'liviano': 2, 'mediano': 4, 'exigente': 6 };
        const MONTH_NAMES = ["ENERO", "FEBRERO", "MARZO", "ABRIL", "MAYO", "JUNIO", "JULIO", "AGOSTO", "SEPTIEMBRE", "OCTUBRE", "NOVIEMBRE", "DICIEMBRE"];

        let state = {
            mainStep: 1,
            isBaselineActive: false,
            baselineIndex: 0,
            subStep: 0,
            formData: {
                goals: [],
                baselines: {},
                books: [], 
                exigencia: null
            },
            calculatedPlan: { pps: 0, durationWeeks: 0, sessions: [] },
            currentMonthOffset: 0,
            currentViewMode: 'calendar',
            listCurrentPage: 0
        };

        const stepContent = document.getElementById('step-content');
        const nextBtn = document.getElementById('next-btn');
        const backBtn = document.getElementById('back-btn');
        const formContainer = document.getElementById('form-container');
        const summaryContainer = document.getElementById('summary-container');
        const calendarGrid = document.getElementById('calendar-grid');
        const listView = document.getElementById('list-view');

        function render() {
            stepContent.innerHTML = '';
            backBtn.classList.toggle('hidden', state.mainStep === 1 && !state.isBaselineActive);
            updateProgressBar();
            document.getElementById('step-badge').innerText = `Sección ${state.mainStep} de 3`;

            if (state.mainStep === 1) {
                if (!state.isBaselineActive) renderStepGoals();
                else renderStepBaseline();
            } else if (state.mainStep === 2) renderStepBooks();
            else if (state.mainStep === 3) renderStepExigencia();

            nextBtn.disabled = !isStepValid();
            nextBtn.querySelector('span').innerText = state.mainStep === 3 ? 'Ver Propuesta' : 'Siguiente';
            lucide.createIcons();
        }

        function updateProgressBar() {
            const bars = document.getElementById('progress-bar').children;
            Array.from(bars).forEach((div, i) => div.style.backgroundColor = i < state.mainStep ? '#C79F32' : '#F5F5F5');
        }

        function renderStepGoals() {
            stepContent.innerHTML = `
                <div class="space-y-6 step-transition">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-medium text-black uppercase tracking-tight">¿Qué objetivo quieres conseguir?</h2>
                        <p class="text-sm font-medium">Selecciona tu meta principal</p>
                    </div>
                    <div class="grid grid-cols-1 gap-4 w-full">
                        <button onclick="toggleGoal('complete_books')" class="w-full p-6 text-left border-2 rounded-custom transition-all ${state.formData.goals.includes('complete_books') ? 'border-[#C79F32] bg-[#F5F5F5] ring-2 ring-[#C79F32]' : 'border-[#A8A8A8] bg-[#FEFEFF] hover:border-[#C79F32]'}">
                            <div class="flex items-start gap-4">
                                <i data-lucide="book-open" class="w-8 h-8 ${state.formData.goals.includes('complete_books') ? 'text-[#C79F32]' : 'text-[#A8A8A8]'}"></i>
                                <div>
                                    <h3 class="font-medium text-black uppercase text-sm">Terminar uno o más libros</h3>
                                    <p class="text-xs mt-1 font-medium leading-relaxed">Calculamos el tiempo ideal basado en tu resistencia actual.</p>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>`;
        }

        function renderStepBaseline() {
            const gid = 'complete_books';
            if (state.subStep === 0) {
                stepContent.innerHTML = `<div class="space-y-8 text-center step-transition">
                    <span class="text-[#C79F32] font-medium text-[10px] uppercase tracking-widest">Diagnóstico</span>
                    <h2 class="text-2xl font-medium text-black mt-2 uppercase">¿Cuántos libros terminaste el último año?</h2>
                    <div class="grid grid-cols-5 gap-3">
                        ${["0", "1", "2", "3", "4+"].map(n => `<button onclick="setBaseline('${gid}', '${n}')" class="aspect-square rounded-custom border-2 font-medium text-xl transition-all ${state.formData.baselines[gid]?.value === n ? 'bg-[#C79F32] border-[#C79F32] text-black' : 'border-[#A8A8A8] bg-[#F5F5F5] text-[#A8A8A8]'}">${n}</button>`).join('')}
                    </div>
                </div>`;
            } else {
                const count = parseInt(state.formData.baselines[gid]?.value) || 0;
                const slots = count >= 4 ? 4 : count;
                stepContent.innerHTML = `<div class="space-y-6 step-transition">
                    <div class="text-center"><h2 class="text-xl font-medium text-black uppercase">¿Qué extensión tenían esos libros?</h2></div>
                    <div class="space-y-4 max-h-[360px] overflow-y-auto pr-2 custom-scrollbar">
                        ${Array.from({length: slots}).map((_, i) => `<div class="p-5 bg-[#F5F5F5] rounded-custom border border-[#A8A8A8]">
                            <p class="text-[10px] font-medium text-[#A8A8A8] mb-3 uppercase tracking-widest">Libro #${i+1}</p>
                            <div class="flex flex-wrap gap-2">
                                ${Object.keys(PAGE_RANGES_MAP).map(r => `<button onclick="setBookDetail(${i}, '${r}')" class="px-3 py-2 rounded-custom text-[10px] font-medium border-2 transition-all uppercase ${state.formData.baselines[gid]?.details?.[i] === r ? 'bg-[#C79F32] border-[#C79F32] text-black' : 'bg-white border-[#A8A8A8]'}">${r}</button>`).join('')}
                            </div>
                        </div>`).join('')}
                    </div>
                </div>`;
            }
        }

        function renderStepBooks() {
            const bBooks = state.formData.baselines['complete_books'];
            let recommendation = "";
            if (bBooks && bBooks.value !== "0") {
                const sumPages = (bBooks.details || []).reduce((acc, r) => acc + PAGE_RANGES_MAP[r], 0);
                const avg = sumPages / (bBooks.details?.length || 1);
                recommendation = `<div class="mt-4 p-4 bg-[#F5F5F5] border border-[#A8A8A8] rounded-custom">
                    <p class="text-[10px] text-[#FF8C00] font-medium italic leading-relaxed">
                        Coach: El año pasado leíste libros de ~${Math.round(avg)} páginas. Si eliges un libro mucho más largo, tu plan durará varios meses para mantener una carga cómoda.
                    </p>
                </div>`;
            }

            stepContent.innerHTML = `<div class="space-y-6 step-transition">
                <div class="text-center mb-6"><h2 class="text-2xl font-medium text-black uppercase tracking-tight">¿Qué libro quieres leer ahora?</h2></div>
                <div class="bg-[#F5F5F5] p-6 rounded-custom border border-[#A8A8A8] space-y-4">
                    <input id="new-book-title" type="text" placeholder="Título del libro" class="w-full p-3 border border-[#A8A8A8] rounded-custom outline-none text-sm bg-white font-medium">
                    <div class="flex gap-2">
                        <input id="new-book-pages" type="number" placeholder="Número de páginas" class="flex-1 p-3 border border-[#A8A8A8] rounded-custom outline-none text-sm bg-white font-medium">
                        <select id="new-book-complexity" class="w-36 p-3 border border-[#A8A8A8] rounded-custom text-xs bg-white outline-none font-medium">
                            <option value="1.0">Ficción</option>
                            <option value="1.25">No Ficción</option>
                            <option value="1.5">Técnico</option>
                        </select>
                    </div>
                    <button onclick="addBook()" class="w-full bg-[#C79F32] text-black py-3 rounded-custom hover:opacity-90 flex items-center justify-center gap-2 text-xs font-medium uppercase tracking-widest"><i data-lucide="plus" class="w-4 h-4"></i> Añadir libro</button>
                </div>
                ${recommendation}
                <div class="space-y-2 max-h-32 overflow-y-auto pr-2 custom-scrollbar">
                    ${state.formData.books.map(b => `<div class="flex items-center justify-between p-4 bg-white border border-[#A8A8A8] rounded-custom">
                        <div class="flex items-center gap-3"><i data-lucide="book-marked" class="text-[#C79F32] w-5 h-5"></i>
                        <div><p class="text-sm font-medium text-black uppercase tracking-tighter">${b.title}</p><p class="text-[9px] text-[#A8A8A8] font-bold uppercase">${b.pages} páginas</p></div></div>
                        <button onclick="removeBook(${b.id})" class="text-[#FF8C00] p-2 hover:bg-[#F5F5F5] rounded-full transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>`).join('')}
                </div>
            </div>`;
        }

        function renderStepExigencia() {
            stepContent.innerHTML = `<div class="space-y-8 step-transition">
                <div class="text-center mb-8"><h2 class="text-2xl font-medium text-black uppercase tracking-tight">¿Qué nivel de exigencia quieres?</h2></div>
                <div class="grid grid-cols-1 gap-4">
                    ${Object.keys(EXIGENCIA_SESSIONS).map(k => `<button onclick="setExigencia('${k}')" class="w-full p-6 text-center border-2 rounded-custom transition-all ${state.formData.exigencia === k ? 'border-[#C79F32] bg-[#F5F5F5] ring-2 ring-[#C79F32]' : 'border-[#A8A8A8] bg-white hover:border-[#C79F32]'}">
                        <h3 class="font-medium text-black uppercase text-lg tracking-wide">${k}</h3>
                        <p class="text-xs font-medium mt-1 uppercase tracking-widest text-black/40">${EXIGENCIA_SESSIONS[k]} sesiones por semana</p>
                    </button>`).join('')}
                </div>
            </div>`;
        }

        // Logic Handlers
        window.toggleGoal = (id) => { state.formData.goals = [id]; render(); };
        window.setBaseline = (gid, val) => { state.formData.baselines[gid] = { ...state.formData.baselines[gid], value: val }; render(); };
        window.setBookDetail = (i, r) => { if (!state.formData.baselines['complete_books'].details) state.formData.baselines['complete_books'].details = []; state.formData.baselines['complete_books'].details[i] = r; render(); };
        window.addBook = () => {
            const t = document.getElementById('new-book-title').value;
            const p = parseInt(document.getElementById('new-book-pages').value);
            const c = document.getElementById('new-book-complexity').value;
            if (t && p) { state.formData.books.push({ id: Date.now(), title: t, pages: p, complexity: parseFloat(c) }); render(); }
        };
        window.removeBook = (id) => { state.formData.books = state.formData.books.filter(b => b.id !== id); render(); };
        window.setExigencia = (v) => { state.formData.exigencia = v; render(); };

        function isStepValid() {
            const d = state.formData;
            if (state.mainStep === 1) {
                if (!state.isBaselineActive) return d.goals.length > 0;
                const b = d.baselines['complete_books'];
                if (!b?.value) return false;
                if (state.subStep === 1) {
                    const count = parseInt(b.value) || 0;
                    return (b.details?.length >= (count >= 4 ? 4 : count)) && b.details.every(item => item);
                }
                return true;
            }
            if (state.mainStep === 2) return d.books.length > 0;
            if (state.mainStep === 3) return !!d.exigencia;
            return true;
        }

        document.getElementById('next-btn').onclick = () => {
            if (state.mainStep === 1) {
                if (!state.isBaselineActive) { state.isBaselineActive = true; state.baselineIndex = 0; state.subStep = 0; }
                else if (state.subStep === 0 && parseInt(state.formData.baselines['complete_books']?.value) > 0) state.subStep = 1;
                else { state.mainStep = 2; state.isBaselineActive = false; }
            } else if (state.mainStep < 3) state.mainStep++;
            else calculateCCLPlan();
            render();
        };

        document.getElementById('back-btn').onclick = () => {
            if (state.mainStep === 1) {
                if (state.subStep === 1) state.subStep = 0;
                else state.isBaselineActive = false;
            } else state.mainStep--;
            render();
        };

        function calculateCCLPlan() {
            const data = state.formData;
            const targetBook = data.books[0];
            let avgPages = 100;
            const bBooks = data.baselines['complete_books'];
            if (bBooks && bBooks.value !== "0") {
                const sum = (bBooks.details || []).reduce((acc, r) => acc + PAGE_RANGES_MAP[r], 0);
                avgPages = sum / (bBooks.details?.length || 1);
            }
            const resistance = avgPages / 10;
            const pps = Math.ceil(Math.max(resistance * K_GROWTH, MIN_PPS));
            const sessionsPerWeek = EXIGENCIA_SESSIONS[data.exigencia];
            const totalSessions = Math.ceil(targetBook.pages / pps);
            const totalWeeks = Math.ceil(totalSessions / sessionsPerWeek);

            state.calculatedPlan = {
                pps: pps,
                durationWeeks: totalWeeks,
                sessions: generateSessions(totalSessions, sessionsPerWeek)
            };

            document.getElementById('propuesta-libro-titulo').innerText = targetBook.title;
            document.getElementById('propuesta-carga').innerText = `Carga Sugerida: ${pps} PÁGINAS / SESIÓN`;
            document.getElementById('propuesta-duracion').innerText = `Duración estimada: ${totalWeeks} semanas`;
            
            formContainer.classList.add('hidden');
            summaryContainer.classList.remove('hidden');
            state.currentMonthOffset = 0;
            state.listCurrentPage = 0;
            renderCalendar();
        }

        function generateSessions(total, perWeek) {
            const sessions = [];
            const patterns = { 2: [1, 4], 4: [1, 3, 5, 0], 6: [1, 2, 3, 4, 5, 6] };
            const myPattern = patterns[perWeek];
            for(let i=0; i<total; i++) {
                const weekNum = Math.floor(i / perWeek);
                const dayOffset = (weekNum * 7) + myPattern[i % perWeek];
                const date = new Date(TODAY);
                date.setDate(TODAY.getDate() + dayOffset);
                if (date >= TODAY) sessions.push({ date, order: i + 1 });
                else total++; 
            }
            return sessions;
        }

        // --- NAVEGACIÓN Y VISTAS ---
        function renderCalendar() {
            const viewDate = new Date(TODAY.getFullYear(), TODAY.getMonth() + state.currentMonthOffset, 1);
            document.getElementById('propuesta-mes-label').innerText = `${MONTH_NAMES[viewDate.getMonth()]} ${viewDate.getFullYear()}`;
            document.getElementById('calendar-prev-month').classList.toggle('disabled', state.currentMonthOffset <= 0);
            
            calendarGrid.innerHTML = '';
            const daysInMonth = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0).getDate();
            const startOffset = viewDate.getDay();

            for(let i=0; i<startOffset; i++) calendarGrid.appendChild(Object.assign(document.createElement('div'), {className: 'h-14 opacity-0'}));

            for(let d=1; d<=daysInMonth; d++) {
                const cellDate = new Date(viewDate.getFullYear(), viewDate.getMonth(), d);
                const cell = document.createElement('div');
                cell.className = 'day-cell relative h-14 rounded-custom flex items-center justify-center group';
                const isPast = cellDate < TODAY && cellDate.toDateString() !== TODAY.toDateString();
                cell.innerHTML = `<span class="absolute top-1 left-1 text-[9px] font-medium ${isPast?'opacity-10':'opacity-30'}">${d}</span>`;
                if(isPast) cell.classList.add('bg-gray-50', 'opacity-50');

                const sess = state.calculatedPlan.sessions.find(s => s.date.toDateString() === cellDate.toDateString());
                if(sess) {
                    const mark = document.createElement('div');
                    mark.className = 'selected-mark w-8 h-8 rounded-full flex items-center justify-center text-black font-medium text-xs';
                    mark.draggable = true;
                    mark.innerText = sess.order;
                    
                    const sessionKey = sess.date.toISOString();
                    mark.addEventListener('dragstart', e => { e.dataTransfer.setData('sessionDate', sessionKey); mark.classList.add('opacity-40'); });
                    mark.addEventListener('dragend', () => mark.classList.remove('opacity-40'));
                    cell.appendChild(mark);
                }

                if(!isPast) {
                    cell.addEventListener('dragover', e => { e.preventDefault(); if(!state.calculatedPlan.sessions.find(s => s.date.toDateString() === cellDate.toDateString())) cell.classList.add('drag-over'); });
                    cell.addEventListener('dragleave', () => cell.classList.remove('drag-over'));
                    cell.addEventListener('drop', e => {
                        e.preventDefault(); cell.classList.remove('drag-over');
                        const originIso = e.dataTransfer.getData('sessionDate');
                        const originDateStr = new Date(originIso).toDateString();
                        if(originIso && originDateStr !== cellDate.toDateString()) {
                            const sessIdx = state.calculatedPlan.sessions.findIndex(s => s.date.toDateString() === originDateStr);
                            if(sessIdx > -1) {
                                state.calculatedPlan.sessions[sessIdx].date = new Date(cellDate);
                                renderCalendar();
                                if(state.currentViewMode === 'list') renderList();
                            }
                        }
                    });
                }
                calendarGrid.appendChild(cell);
            }
            updateHeight();
        }

        function renderList() {
            listView.innerHTML = '';
            const allSorted = Array.from(state.calculatedPlan.sessions).sort((a,b) => a.date - b.date);
            const totalSessions = allSorted.length;
            
            if(totalSessions === 0) { 
                listView.innerHTML = '<p class="text-center text-[10px] uppercase font-medium opacity-40 py-8 tracking-widest">Sin sesiones</p>'; 
                document.getElementById('list-pagination').classList.add('hidden');
                return; 
            }

            const totalPages = Math.ceil(totalSessions / SESSIONS_PER_PAGE);
            document.getElementById('list-pagination').classList.remove('hidden');
            document.getElementById('list-page-info').innerText = `${state.listCurrentPage + 1} / ${totalPages}`;
            document.getElementById('list-prev-page').classList.toggle('disabled', state.listCurrentPage <= 0);
            document.getElementById('list-next-page').classList.toggle('disabled', state.listCurrentPage >= totalPages - 1);

            const startIdx = state.listCurrentPage * SESSIONS_PER_PAGE;
            const pageSessions = allSorted.slice(startIdx, startIdx + SESSIONS_PER_PAGE);
            
            pageSessions.forEach((s) => {
                const monthName = MONTH_NAMES[s.date.getMonth()];
                listView.innerHTML += `<div class="flex items-center justify-between p-3 bg-white border border-[#A8A8A8] rounded-custom shadow-sm mb-2 step-transition">
                    <div class="flex items-center space-x-3">
                        <div class="w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-medium text-black bg-[#C79F32]">${s.order}</div>
                        <span class="text-xs font-medium text-black uppercase tracking-tight">Sesión de Lectura</span>
                    </div>
                    <span class="text-[10px] font-medium text-black opacity-60 uppercase tracking-tighter">${s.date.getDate()} ${monthName}</span>
                </div>`;
            });
            updateHeight();
        }

        function updateHeight() {
            const container = document.getElementById('main-view-container');
            const active = state.currentViewMode === 'calendar' ? document.getElementById('calendar-view-wrapper') : document.getElementById('list-view-wrapper');
            setTimeout(() => container.style.height = active.offsetHeight + 'px', 50);
        }

        // Eventos Toggle
        document.getElementById('toggle-calendar').onclick = () => {
            state.currentViewMode = 'calendar';
            document.getElementById('toggle-calendar').classList.add('active');
            document.getElementById('toggle-list').classList.remove('active');
            document.getElementById('calendar-view-wrapper').classList.replace('view-hidden', 'view-visible');
            document.getElementById('list-view-wrapper').classList.replace('view-visible', 'view-hidden');
            document.getElementById('calendar-nav-controls').classList.remove('hidden');
            document.getElementById('list-pagination').classList.add('hidden');
            renderCalendar();
        };

        document.getElementById('toggle-list').onclick = () => {
            state.currentViewMode = 'list';
            document.getElementById('toggle-list').classList.add('active');
            document.getElementById('toggle-calendar').classList.remove('active');
            document.getElementById('list-view-wrapper').classList.replace('view-hidden', 'view-visible');
            document.getElementById('calendar-view-wrapper').classList.replace('view-visible', 'view-hidden');
            document.getElementById('calendar-nav-controls').classList.add('hidden');
            renderList();
        };

        document.getElementById('list-prev-page').onclick = () => { if(state.listCurrentPage > 0) { state.listCurrentPage--; renderList(); } };
        document.getElementById('list-next-page').onclick = () => {
            const totalPages = Math.ceil(state.calculatedPlan.sessions.length / SESSIONS_PER_PAGE);
            if(state.listCurrentPage < totalPages - 1) { state.listCurrentPage++; renderList(); }
        };

        document.getElementById('calendar-prev-month').onclick = () => { if(state.currentMonthOffset > 0) { state.currentMonthOffset--; renderCalendar(); } };
        document.getElementById('calendar-next-month').onclick = () => { state.currentMonthOffset++; renderCalendar(); };
        document.getElementById('adjust-btn').onclick = () => { summaryContainer.classList.add('hidden'); formContainer.classList.remove('hidden'); state.mainStep = 1; state.isBaselineActive = false; render(); };

        // Init
        formContainer.classList.remove('hidden');
        render();
    </script>
</body>
</html>